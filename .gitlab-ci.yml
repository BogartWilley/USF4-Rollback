workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"

stages:
  - build
  - upload

.shared_windows_runners:
  tags:
  - shared-windows
  - windows
  - windows-1809

# See https://docs.gitlab.com/ee/user/project/releases/release_fields.html#use-a-generic-package-for-attaching-binaries
variables:
  PACKAGE_VERSION: "0.0.1"
  MSI_PACKAGE: "${CI_PROJECT_NAME}-${PACKAGE_VERSION}-win32.msi"
  PACKAGE_REGISTRY_URL: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${CI_PROJECT_NAME}/${PACKAGE_VERSION}"

build-job:
  stage: build
  extends:
  - .shared_windows_runners
  script:
    - cmake.exe --build ./build
    - cmake.exe --build ./build --target package
  before_script:
    - If (!(test-path vcpkg-cache)) { mkdir -p vcpkg-cache }
    - $env:VCPKG_DEFAULT_BINARY_CACHE="$PWD\vcpkg-cache"
    - >
        cmake.exe
        -B build
        -G "Ninja"
        -DCMAKE_BUILD_TYPE="Release"
        -DCMAKE_TOOLCHAIN_FILE:FILEPATH="C:/vcpkg/scripts/buildsystems/vcpkg.cmake"
        -DX_VCPKG_APPLOCAL_DEPS_INSTALL:BOOL="True"
  cache:
    - key:
        files:
          - vcpkg.json
          - vcpkg-configuration.json
      paths:
        - vcpkg-cache
  artifacts:
    paths:
      - "./build/${MSI_PACKAGE}"

upload-job:
  stage: upload
  extends:
    - .shared_windows_runners
  script:
    - >
      curl.exe --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file "./build/${MSI_PACKAGE}" "${PACKAGE_REGISTRY_URL}/${MSI_PACKAGE}"
